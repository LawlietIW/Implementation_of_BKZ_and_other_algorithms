if __name__ == "__main__":
    from utils.utilFunctions import *
else:
    from BKZ_first_implementation.utils.utilFunctions import *
import time

import time as time

def size_reduction(k, Bm,B_gs,Mym):
    # print("HE")
    # print(np.round(Mym,4))
    for j in reversed(range(0,k)):
        # print(k,j)
        # print(np.round(Mym,4))
        qj = np.round(Mym[k,j])
        Bm[k,:] = Bm[k,:] - qj*Bm[j,:]
        # print(Bm)
        B_gs, Mym = gram_schmidt(Bm)
    return Bm,B_gs, Mym


def remove_dependency(k, Bm):
    Bm = np.delete(Bm, k, 0)
    B_gs, Mym = gram_schmidt(Bm)
    B_gs_norm = calc_norm(B_gs)
    return Bm, B_gs, Mym, B_gs_norm

def Galbraith_LLL_removing_linear_dependence(Bm,delta = 3/4, norm_cutoff = 0.001):
    """
    Beware that close vectors might be removed, so they can't be TOO close 
    """
    n, columns = Bm.shape  #number of rows
    B_gs, Mym = gram_schmidt(Bm)
    # print("B_gs:")
    # print(np.round(B_gs))
    # print(np.round(Mym,4))
    B_gs_norm = calc_norm(B_gs)
    k = 1
    while k < n:
        # print(k)
        if k  <= columns - 1:
            #If we have more rows than columns, we have linear dependence, and thus we can't do LLL before we remove this
            Bm,B_gs,Mym = size_reduction(k, Bm,B_gs,Mym)
        # print(B_gs_norm[k])
        if B_gs_norm[k] < norm_cutoff:    #Must think more here
            """So if very close to 0, in other words seems like linearly dependent"""
            Bm, B_gs, Mym, B_gs_norm = remove_dependency(k,Bm)
            n -= 1
            k = 1
            # print("Removed a vector")
            # print(Bm)
            # print(B_gs)
            # print(Mym)
            # print()
        elif B_gs_norm[k] >= (delta - Mym[k,k-1]**2)*B_gs_norm[k-1]:
            k = k + 1
        else:
            Bm[[k, k-1],:] = Bm[[k-1, k],:]
            B_gs, Mym = gram_schmidt(Bm)
            B_gs_norm = calc_norm(B_gs)
            k = max(1,k-1)
    return Bm




def angle_between_vectors_in_degrees(vector1, vector2):
    """
    Just ChatGpt on this one cause lazy
    """
    dot_product = np.dot(vector1, vector2)
    magnitude1 = np.linalg.norm(vector1)
    magnitude2 = np.linalg.norm(vector2)
    
    cosine_angle = dot_product / (magnitude1 * magnitude2)
    angle_in_radians = np.arccos(np.clip(cosine_angle, -1.0, 1.0))
    angle_in_degrees = np.degrees(angle_in_radians)
    
    return angle_in_degrees

if __name__ == "__main__":
    # Bm = np.array([[13, 22, 32, 14], 
    #                [43, 54, 53, 153], 
    #                [43, 51, 6, 1],
    #                [46, 431, 6, 14],
    #                [43, 51, 6, 1]])
    # Bm = np.array([
    # [ -7,  0, -1,-17,-38, 11, 27],
    # [  2, -9,-20, 25, 24, 35, -5],
    # [ 11, 51, 13,-24, 27,  7, 15],
    # [ 29,  5, -3, 33,-37,-36, -5],
    # [ 53,  0,-24, -5, 10, 19,-29],
    # [  8,-39,-63,  4, 18,-21, 13],
    # [ 47,-22, 52,-12, 43, 22, 10],
    # [ -8, 39, 63, -4,-18, 21,-13]]) 
    Bm =  np.array([[381, 372, 479, 114, 178, 393, 348, 131, 229, 313, 260, 225, 304, 428,
  134,  70, 458, 156,  48, 158, 154, 472, 448,  98,  89, 458,  74, 404,
  129, 202],
 [330,  67, 110,  82, 187, 183, 113, 341, 224,  53, 372,  74, 361, 456,
  308, 342, 134,  59, 410, 324, 141, 279, 450, 224, 158, 453, 281, 276,
   97, 484],
 [485, 374, 381, 287, 415, 362, 252, 305, 282, 365, 143, 432, 470, 117,
  364,  29, 293,  79, 317,  28, 227,  51, 192, 120, 185, 303, 453,  14,
  366, 485],
 [365, 335,  33, 431,  22, 368,  80, 425, 446, 104, 498, 477, 329, 295,
  435, 203, 379,  30,  18, 374, 470, 266, 305, 329,  96, 361, 339, 378,
   18, 416],
 [ 10, 419, 201, 128, 177, 202, 263, 355, 310,  76, 206,  49, 314, 105,
   68, 207,   3, 184, 476,  29, 333, 420, 239, 432,  85, 260, 250, 295,
  292, 304],
 [424, 432, 406, 164, 124, 102, 125, 461, 340, 326, 275, 343, 150, 404,
  357, 207, 177, 107, 116, 287, 197,  36,  92,  40, 204,  13, 138, 306,
  176, 493],
 [ 67, 225,  43, 233, 320, 436, 215, 248, 154, 145, 118, 407, 387, 414,
  305, 425, 387, 368,  95,  24, 271, 141,  65, 351, 440, 172, 423, 192,
   35, 333],
 [318, 460, 190,  65, 448,  49, 449, 225, 355, 149,  79,  82,  11, 330,
  130, 246, 222, 122, 202, 163,   5, 129, 278, 316, 253, 445,  47, 459,
    0, 276],
 [342, 148,  72, 238, 359, 262, 309,  80,  88, 499,   0,  48, 228,  56,
  265,  40, 388, 178, 321, 321, 496, 499, 275, 318,  56, 227, 321, 218,
  238, 237],
 [177,  29, 153, 300,  42, 289, 395, 288, 184, 331, 297, 252,  21, 136,
  394,  30, 356, 162, 387, 319, 126,   8, 235,  74, 101, 245, 211, 492,
  122,  30],
 [195, 171, 353,  33, 261, 256, 114, 170, 395, 119, 492, 498, 471, 224,
  146, 277, 326, 128, 339, 360,  15, 288,  47, 484, 320, 494, 146, 423,
   55, 239],
 [373, 300,  32, 224,  52,  15,  71, 260, 316, 117,  92,  30, 286, 302,
   87, 162, 262,  57, 412, 204,  10, 465, 274, 411, 401,   7, 447, 412,
  249, 160],
 [454, 144,   2, 332, 131, 130, 173, 480, 222, 239, 453, 449, 396, 175,
   27, 159, 249, 450, 220, 231, 279, 481, 282, 372, 368,  27,  34, 422,
  435,  98],
 [ 22,  33, 223,  68, 412,  44, 140, 316, 150, 288, 186,  40, 368, 466,
  405, 387, 294, 436, 407,  79, 198, 479, 290, 306, 420,  17, 490, 210,
  456, 125],
 [236, 435, 107, 238, 332, 221, 436, 412, 394, 316, 427, 200, 406, 359,
  446, 199, 145, 434, 410, 186, 380, 239, 226, 144, 347, 244, 317, 343,
  179, 499],
 [ 30, 178, 423, 151, 439, 487,  66, 204, 479,  77, 144, 459, 425, 287,
  113, 237, 352, 466, 183,  22, 423, 388, 154, 175, 190, 397, 420,  99,
  494, 187],
 [340, 274, 429, 105, 456, 234, 173, 421,  99, 348, 255, 486, 353, 224,
  293, 274, 291,  16, 212, 344, 447, 300, 162, 132, 454, 348, 204,  58,
  211, 427],
 [302,  32, 228, 413, 344, 252, 210, 120, 431, 368, 134, 371,  48, 377,
  211, 152, 167,  93, 145, 173, 116, 448, 442, 485, 402, 224, 364, 101,
  229, 298],
 [190,  72, 256,  61, 477, 433, 236, 327, 284, 165, 298, 170, 326, 156,
  397, 301, 242, 196,  75, 207, 356,  11, 367,  66, 148, 234, 278,  75,
  287, 259],
 [358, 322, 190,  61, 299, 484, 435, 297, 428,  34, 419, 232, 496, 273,
  196, 320, 424, 120, 114, 438, 140,  92,   2, 484, 439, 457, 353, 197,
   22, 253],
 [468, 254, 139, 424, 109, 348, 194, 278, 275, 255, 368, 240, 204, 129,
  190, 474, 171, 282, 481, 332, 212, 485, 177, 401, 391, 374, 382, 299,
  288, 477],
 [173, 115, 473, 310, 459, 282,  16, 226, 278,  10, 375, 421, 141, 318,
  274, 152,  81, 198,  74, 314,  21, 446, 443, 411, 354, 346,   2, 291,
  222, 480],
 [ 84, 434, 270, 485, 401, 377, 281, 180, 193, 458, 351, 330, 426, 283,
   96, 137, 474, 306, 255, 493, 340, 227, 381, 332, 483, 280,  85,  36,
  466, 186],
 [451, 363, 484,  99, 426,  34, 258, 212, 115, 437, 106,   2,  32, 353,
  496, 418, 386, 358, 155, 235, 268, 405, 321,  80,  67, 287, 451, 462,
  271, 388],
 [244, 451, 209,  94, 176, 118, 153, 133, 347,  21, 189, 467, 458, 456,
  423, 123,  43,  21, 296, 121, 443, 147, 321, 149, 112, 346,  39, 295,
  136, 360],
 [151, 287,  39, 339, 246, 144,  64, 359, 134, 318,  21, 357, 139, 440,
  242, 181, 215, 381,  62, 230, 287, 109, 444, 450, 222, 442,  35, 260,
  433, 114],
 [226, 377,  18, 273, 162, 383, 471, 290, 314, 263, 276, 450,  86, 277,
  138,  70, 296,  45, 136, 248, 135, 356, 174, 134, 264, 496, 350, 295,
  157, 454],
 [ 98, 264,  59,  11, 321, 132, 219,  60, 312, 212, 334, 320,  37, 323,
  158, 395, 467, 345, 104, 289, 263, 390, 446, 208, 338, 254, 331, 192,
  116, 236],
 [146, 216,   5, 365, 138, 157, 205, 266, 329, 182,  17, 302,  66, 199,
  104, 133, 139,  70, 326, 329, 149, 497, 275, 321, 499, 130,  74, 220,
  133, 158],
 [337,   9, 186,  88,  90, 240,  49, 272, 113, 420, 427, 287, 115, 403,
  186, 119, 198, 273, 176, 252, 235, 442, 109, 100, 474, 210, 127, 348,
  238,  79]])
#     Bm = np.array([[6, 4, 0],
#  [2, 8, 5],
#  [1, 7, 1]])
    # print("B:")
    # print(Bm)
    # print(gram_schmidt(Bm)[0])
    # print()
    start = time.time()
    Bm = Galbraith_LLL_removing_linear_dependence(Bm)
    print("Time:", time.time()-start)
    # print("Svar\n", Bm)
    # for i in range(len(Bm)):
    #     for j in range(len(Bm)):
    #         print(angle_between_vectors_in_degrees(Bm[i],Bm[j]))




